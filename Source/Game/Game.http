###############################################
### Game API Testing - Comprehensive Test Suite
###############################################
###
### Prerequisites:
### 1. AppHost running
### 2. Find actual port in AppHost logs
### 3. Auth disabled for testing (or create test user)
###
###############################################

### Variables (UPDATE WITH ACTUAL PORT!)
@authUrl = https://localhost:7050
@baseUrl = https://localhost:7173

###############################################
### SETUP - AUTHENTICATION
###############################################

### 0a. Register Test User
POST {{authUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "Test123!",
  "confirmPassword": "Test123!",
  "name": "Test User"
}

### 0b. Login (Cookie auto-captured for subsequent requests)
# @name login
POST {{authUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "Test123!"
}

### 0c. Verify Authenticated
GET {{authUrl}}/api/auth/me

### After Login - Get User ID from response above
### Use csharprepl to run the command below:
###  Base64UrlTextEncoder.Encode(new Guid("put-user-id-here").ToByteArray())
@encodedUserId = 8sCZAY0Pn3KUcaTkxZ7t1w

###############################################
### HEALTH CHECKS
###############################################

### Health Check
GET {{baseUrl}}/health

### Alive Check
GET {{baseUrl}}/alive

###############################################
### GAME SESSION CRUD
###############################################

### 1. Create Game Session
# @name session
POST {{baseUrl}}/api/sessions
x-user: {{encodedUserId}}
Content-Type: application/json

{
  "title": "Curse of Strahd - Session 1"
}

### 2. Get All Game Sessions
GET {{baseUrl}}/api/sessions
x-user: {{encodedUserId}}

### 3. Get Game Session by ID
GET {{baseUrl}}/api/sessions/{{session.response.body.$.id}}
x-user: {{encodedUserId}}

### 4. Update Game Session Title
PATCH {{baseUrl}}/api/sessions/{{session.response.body.$.id}}
x-user: {{encodedUserId}}
Content-Type: application/json

{
  "title": "Curse of Strahd - Session 1 (Continued)"
}

###############################################
### PLAYER MANAGEMENT
###############################################

### 5. Join Game Session as Player
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/join
x-user: {{encodedUserId}}
Content-Type: application/json

{
  "joinAs": "Player"
}

### 6. Join Game Session as Observer
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/join
x-user: {{encodedUserId}}
Content-Type: application/json

{
  "joinAs": "Observer"
}

### 7. Leave Game Session
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/leave
x-user: {{encodedUserId}}
Content-Type: application/json

{}

###############################################
### SESSION LIFECYCLE
###############################################

### 8. Start Game Session (Status → InProgress)
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/start
x-user: {{encodedUserId}}
Content-Type: application/json

{}

### 9. Set Active Encounter
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/encounters/00000000-0000-0000-0000-000000000000/activate
x-user: {{encodedUserId}}
Content-Type: application/json

{}

### 10. Stop Game Session (Status → Finished)
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/stop
x-user: {{encodedUserId}}
Content-Type: application/json

{}

###############################################
### DELETE OPERATIONS
###############################################

### 11. Delete Game Session
DELETE {{baseUrl}}/api/sessions/{{session.response.body.$.id}}
x-user: {{encodedUserId}}

###############################################
### EDGE CASES & VALIDATION
###############################################

### 12. Invalid - Missing Title
POST {{baseUrl}}/api/sessions
x-user: {{encodedUserId}}
Content-Type: application/json

{
  "description": "Missing required title field"
}

### 13. Invalid - Missing JoinAs Parameter
POST {{baseUrl}}/api/sessions/{{session.response.body.$.id}}/join
x-user: {{encodedUserId}}
Content-Type: application/json

{}

### 14. Not Found - Get Non-Existent Session
GET {{baseUrl}}/api/sessions/00000000-0000-0000-0000-000000000000
x-user: {{encodedUserId}}

### 15. Not Found - Update Non-Existent Session
PATCH {{baseUrl}}/api/sessions/00000000-0000-0000-0000-000000000000
x-user: {{encodedUserId}}
Content-Type: application/json

{
  "title": "Should Return 404"
}

### 16. Not Found - Delete Non-Existent Session
DELETE {{baseUrl}}/api/sessions/00000000-0000-0000-0000-000000000000
x-user: {{encodedUserId}}
